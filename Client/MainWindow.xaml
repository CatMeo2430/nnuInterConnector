<Window x:Class="Client.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:Client"
        mc:Ignorable="d"
        Title="NNU InterConnector - 校园网P2P互联工具" Height="650" Width="900"
        WindowStartupLocation="CenterScreen">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="200"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="#2C3E50" Padding="15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="IP: " FontSize="16" FontWeight="Bold" Foreground="White" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding MyIp}" FontSize="16" Foreground="#ECF0F1" VerticalAlignment="Center" Margin="5,0,15,0"/>
                    <TextBlock Text="ID: " FontSize="16" FontWeight="Bold" Foreground="White" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding MyId}" FontSize="18" FontWeight="Bold" Foreground="#3498DB" VerticalAlignment="Center" Margin="5,0,5,0"/>
                    <Button Content="复制" Width="50" Height="25" FontSize="11" 
                            Command="{Binding CopyIdCommand}" 
                            Background="#95A5A6" Foreground="White" 
                            Padding="5,2" Margin="5,0,15,0"
                            ToolTip="复制ID到剪贴板">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border Background="{TemplateBinding Background}" 
                                                    BorderBrush="{TemplateBinding BorderBrush}"
                                                    BorderThickness="{TemplateBinding BorderThickness}"
                                                    CornerRadius="3">
                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="#7F8C8D"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="20,0,0,0">
                    <TextBox Text="{Binding TargetId, UpdateSourceTrigger=PropertyChanged}" Width="150" Height="30" 
                             VerticalContentAlignment="Center" FontSize="14" Margin="0,0,10,0"
                             ToolTip="输入对方的6位数字ID"/>
                    <Button Content="连接" Width="80" Height="30" FontSize="14" FontWeight="Bold"
                            Command="{Binding ConnectToPeerCommand}" 
                            Background="#3498DB" Foreground="White">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border Background="{TemplateBinding Background}" 
                                                    BorderBrush="{TemplateBinding BorderBrush}"
                                                    BorderThickness="{TemplateBinding BorderThickness}"
                                                    CornerRadius="4">
                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="#2980B9"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <Grid Grid.Row="1" Margin="15">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <GroupBox Grid.Column="0" Header="已建立的连接" Margin="0,0,10,0" BorderBrush="#BDC3C7" BorderThickness="1">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <DataGrid Grid.Row="0" ItemsSource="{Binding Connections}" 
                              SelectedItem="{Binding SelectedConnection}"
                              AutoGenerateColumns="False" 
                              CanUserAddRows="False"
                              GridLinesVisibility="Horizontal"
                              HeadersVisibility="Column"
                              BorderBrush="#ECF0F1"
                              BorderThickness="1">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="对方ID" Binding="{Binding PeerId}" Width="80"/>
                            <DataGridTextColumn Header="对方IP" Binding="{Binding PeerIp}" Width="120"/>
                            <DataGridTemplateColumn Header="状态" Width="80">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Status}" 
                                                   Foreground="{Binding StatusColor}" 
                                                   FontWeight="Bold"
                                                   HorizontalAlignment="Center" 
                                                   VerticalAlignment="Center"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn Header="连接时间" Binding="{Binding ConnectedTime, StringFormat='{}{0:MM-dd HH:mm:ss}'}" Width="130"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <Button Grid.Row="1" Content="断开选中连接" Height="35" Margin="0,10,0,0"
                            Command="{Binding DisconnectSelectedCommand}" 
                            Background="#E74C3C" Foreground="White" FontWeight="Bold"
                            IsEnabled="{Binding SelectedConnection}">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border Background="{TemplateBinding Background}" 
                                                    BorderBrush="{TemplateBinding BorderBrush}"
                                                    BorderThickness="{TemplateBinding BorderThickness}"
                                                    CornerRadius="4">
                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="#C0392B"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </Grid>
            </GroupBox>

            <Border Grid.Column="1" Width="2" Background="#BDC3C7" Margin="10,0"/>

            <GroupBox Grid.Column="2" Header="快速说明" Width="200" Margin="10,0,0,0" BorderBrush="#BDC3C7" BorderThickness="1">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <TextBlock TextWrapping="Wrap" Padding="5" FontSize="12" Foreground="#34495E">
                        <Run FontWeight="Bold" FontSize="13" Foreground="#2C3E50">使用说明：</Run>
                        <LineBreak/><LineBreak/>
                        <Run FontWeight="Bold">1.</Run> 启动后自动获取ID<LineBreak/>
                        <Run FontWeight="Bold">2.</Run> 输入对方ID点击连接<LineBreak/>
                        <Run FontWeight="Bold">3.</Run> 等待对方确认<LineBreak/>
                        <Run FontWeight="Bold">4.</Run> 自动配置防火墙和路由<LineBreak/>
                        <Run FontWeight="Bold">5.</Run> 完成后可直接通信<LineBreak/><LineBreak/>
                        <Run FontWeight="Bold" FontSize="13" Foreground="#2C3E50">注意事项：</Run>
                        <LineBreak/><LineBreak/>
                        <Run>• 仅支持校园网10.20/10.30网段</Run>
                        <LineBreak/>
                        <Run>• 同网段自动配置强制路由</Run>
                        <LineBreak/>
                        <Run>• 断开时自动清理配置</Run>
                        <LineBreak/>
                        <Run>• 需要Helper.exe管理员权限</Run>
                    </TextBlock>
                </ScrollViewer>
            </GroupBox>
        </Grid>

        <GroupBox Grid.Row="2" Header="运行日志" Margin="15,0,15,15" BorderBrush="#BDC3C7" BorderThickness="1">
            <ScrollViewer x:Name="LogScrollViewer" VerticalScrollBarVisibility="Auto">
                <TextBox Text="{Binding LogText}" 
                         FontFamily="Consolas" FontSize="12"
                         Background="#2C3E50" Foreground="#ECF0F1"
                         IsReadOnly="True" 
                         BorderThickness="0"
                         TextWrapping="Wrap"
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                         Padding="10"/>
            </ScrollViewer>
        </GroupBox>
    </Grid>
</Window>
